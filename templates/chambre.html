<!doctype html>
<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', filename='') }}" data-template="vertical-menu-template-free" data-style="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
    <title>Chambre {{ room.room_number }} - Gestion | Détection de Chute</title>
    <meta name="description" content="Détails d'une chambre pour la gestion de chutes dans un EHPAD." />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fonts/boxicons.css') }}" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/core.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/theme-default.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/demo.css') }}" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/libs/apex-charts/apex-charts.css') }}" />

    <!-- Helpers -->
    <script src="{{ url_for('static', filename='vendor/js/helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>

    <!-- Include dayjs and socket.io libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.10.7/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

    <!-- Custom Notification Modal and Alert Sound -->
    <style>
      #alertModal .modal-body {
        text-align: center;
      }
      #alertRoom {
        font-size: 2.5rem;
        color: red;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      #alertTimer {
        font-size: 2rem;
        color: black;
        font-weight: bold;
        margin-bottom: 1rem;
      }
      #alertVideoPlayer {
        width: 100%;
        height: auto;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo">
            <a href="/" class="app-brand-link">
              <img src="{{ url_for('static', filename='/img/logo.png') }}" alt="Protect Care Logo" class="app-brand-logo demo" />
            </a>
          </div>
          <div class="menu-inner-shadow"></div>
          <ul class="menu-inner py-1">
            <li class="menu-item">
              <a href="/tables-basic" class="menu-link">
                <i class="menu-icon tf-icons bx bx-bar-chart-alt-2"></i>
                <div>Tableau de Bord</div>
              </a>
            </li>
            <li class="menu-item active">
              <a href="/chambres" class="menu-link">
                <i class="menu-icon tf-icons bx bx-file"></i>
                <div>Chambres</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="/contact" class="menu-link">
                <i class="menu-icon tf-icons bx bx-envelope"></i>
                <div>Contact</div>
              </a>
            </li>
          </ul>
        </aside>

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          <nav class="layout-navbar navbar navbar-expand-xl navbar-detached bg-navbar-theme">
            <div class="container-xxl">
              <div class="navbar-nav-right d-flex align-items-center">
                <ul class="navbar-nav flex-row align-items-center ms-auto">
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                      <i class="bx bx-bell bx-sm"></i>
                    </a>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                      <i class="bx bx-user-circle bx-sm"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">Déconnexion</a></li>

                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>

          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <div class="row">
                <div class="col-lg-12 mb-4">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="m-0">Chambre {{ room.room_number }} - Détails</h5>
                    </div>
                    <div class="card-body">
                      <h6>Informations Générales</h6>
                      <p><strong>Numéro de Chambre :</strong> {{ room.room_number }}</p>
                      <p><strong>Étage :</strong> {{ room.floor }}</p>
                      <p><strong>Type de Chambre :</strong> {{ room.type }}</p>
                      <p><strong>Statut :</strong> {{ 'Occupée' if room.occupied else 'Disponible' }}</p>
                      <p><strong>ID Raspberry :</strong> {{ room.raspberry_id }}</p>
                      <h6>Nombre de Chutes</h6>
                      <p id="incident_count">Aucune chute détectée ce mois-ci.</p>
                    </div>
                  </div>
                </div>

                <div class="col-lg-12 mb-4">
                  <div class="card">
                    <h5 class="card-header">Historique des Chutes</h5>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Date et Heure</th>
                            <th>État</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody id="incidents_table_body">
                          <tr>
                            <td colspan="3">Chargement des incidents...</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- Layout page -->
      </div>
    </div>

    <!-- Video Modal Template -->
    <div id="videoModals"></div>

    <!-- Modal for Alerts -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertModalLabel">Nouvelle Alerte de Chute</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="alertRoom"></p>
            <p id="alertTimer">00:00</p>
            <!-- Video Player -->
            <video id="alertVideoPlayer" controls>
              <source id="alertVideoSource" src="" type="video/mp4">
              Votre navigateur ne supporte pas la lecture vidéo.
            </video>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="markAsSeenButton" onclick="markAsSeen()">Vue</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ajouter un élément audio pour le son d'alerte -->
    <audio id="alertSound" src="{{ url_for('static', filename='/audio/alerte.mp3') }}" preload="auto"></audio>

    <!-- Core JS -->
    <script src="{{ url_for('static', filename='vendor/libs/jquery/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/libs/popper/popper.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/bootstrap.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/menu.js') }}"></script>

    <script>

      $(document).ready(function() {
        const roomNumber = "{{ room.room_number }}";
        const incidentsUrl = `/api/incidents/room/${roomNumber}/incidents`;

        // Fetch the incidents for the room
        $.get(incidentsUrl, function(data) {
          const incidents = data.incidents;
          let incidentsHtml = '';
          let incidentCount = 0;

          if (incidents && incidents.length > 0) {
            incidents.forEach(incident => {
              incidentCount += 1;
              incidentsHtml += `
                <tr>
                  <td>${incident.incident_date}</td>
                  <td><span class="badge bg-danger">${incident.status}</span></td>
                  <td><button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#videoModal${incident.incident_id}">Regarder</button></td>
                </tr>
              `;

              // Generate modal for each video
              const videoModalHtml = `
                <div class="modal fade" id="videoModal${incident.incident_id}" tabindex="-1" aria-labelledby="videoModalLabel${incident.incident_id}" aria-hidden="true">
                  <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="videoModalLabel${incident.incident_id}">Vidéo Incident ${incident.incident_id}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <video controls>
                          <source src="${incident.video_url}" type="video/mp4">
                          Votre navigateur ne supporte pas la lecture vidéo.
                        </video>
                      </div>
                    </div>
                  </div>
                </div>
              `;
              $("#videoModals").append(videoModalHtml);
            });

            $('#incident_count').text(`${incidentCount} chutes détectées ce mois-ci.`);
          } else {
            incidentsHtml = '<tr><td colspan="3">Aucune chute enregistrée pour cette chambre.</td></tr>';
          }

          $('#incidents_table_body').html(incidentsHtml);
        }).fail(function() {
          $('#incidents_table_body').html('<tr><td colspan="3">Erreur lors du chargement des incidents.</td></tr>');
        });
      });
    </script>

    <!-- Notification script -->
    <script type="text/javascript">
      var socket = io('{{server_url}}', {
        transports: ['websocket'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 2000
      });

      socket.on('connect', function() {
        console.log('Connected to SocketIO server');
      });

      socket.on('notification', function(data) {
        console.log('New incident received:', data);

        const room = data.message.split("Room ")[1] || "Unknown";  // Extract room number
        const videoUrl = data.video_url;  // Extract video URL

        // Play the alert sound when a notification is received
        var alertSound = document.getElementById('alertSound');
        alertSound.play().catch(function() {
          console.log('Lecture audio bloquée jusqu\'à une interaction utilisateur');
        });

        // Display the alert popup with the room number and video player
        showAlertPopup(room, videoUrl);
      });

      socket.on('disconnect', function() {
        console.log('Disconnected from SocketIO server');
      });

      var timerInterval;

      function showAlertPopup(room, videoUrl) {
        document.getElementById('alertRoom').textContent = "Chambre " + room;
        document.getElementById('alertVideoSource').src = videoUrl;
        document.getElementById('alertVideoPlayer').load();
        startTimer();

        var alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
        alertModal.show();
      }

      function startTimer() {
        var timerDisplay = document.getElementById('alertTimer');
        var seconds = 0;
        timerInterval = setInterval(function() {
          seconds++;
          var minutes = Math.floor(seconds / 60);
          var remainingSeconds = seconds % 60;
          timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }, 1000);
      }

      function markAsSeen() {
        clearInterval(timerInterval);
        var alertModal = bootstrap.Modal.getInstance(document.getElementById('alertModal'));
        alertModal.hide();

        var alertSound = document.getElementById('alertSound');
        alertSound.pause();
        alertSound.currentTime = 0;
      }
    </script>


    <script>
          document.addEventListener("DOMContentLoaded", function () {
      const token = localStorage.getItem('token');

      if (!token) {
        window.location.href = "/";
      }

      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('token');
        window.location.href = "/";
      })});
    </script>
  </body>
</html>
