<!doctype html>

<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', filename='') }}" data-template="vertical-menu-template-free" data-style="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Chambre {{ room.room_number }} - Gestion | Détection de Chute</title>
    <meta name="description" content="Détails d'une chambre pour la gestion de chutes dans un EHPAD." />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fonts/boxicons.css') }}" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/core.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/theme-default.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/demo.css') }}" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/libs/apex-charts/apex-charts.css') }}" />

    <!-- Helpers -->
    <script src="{{ url_for('static', filename='vendor/js/helpers.js') }}"></script>
    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
  </head>

  <body>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
      <div class="layout-container">
        <!-- Menu -->
        <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
          <div class="app-brand demo" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 0; height: auto; box-sizing: border-box;">
            <a href="/" class="app-brand-link" style="display: flex; align-items: center; justify-content: center; width: 100%; max-width: 200px;">
              <img src="{{ url_for('static', filename='/img/logo.png') }}" alt="Protect Care Logo" class="app-brand-logo demo" style="max-width: 90%;" />
            </a>
          </div>
          <div class="menu-inner-shadow"></div>
          <ul class="menu-inner py-1">
            <li class="menu-item">
              <a href="/tables-basic" class="menu-link">
                <i class="menu-icon tf-icons bx bx-bar-chart-alt-2"></i>
                <div>Tableau de Bord</div>
              </a>
            </li>
            <li class="menu-item active">
              <a href="/chambres" class="menu-link">
                <i class="menu-icon tf-icons bx bx-file"></i>
                <div>Chambres</div>
              </a>
            </li>
            <li class="menu-item">
              <a href="/contact" class="menu-link">
                <i class="menu-icon tf-icons bx bx-envelope"></i>
                <div>Contact</div>
              </a>
            </li>
          </ul>
        </aside>

        <!-- Layout container -->
        <div class="layout-page">
          <!-- Navbar -->
          <nav class="layout-navbar navbar navbar-expand-xl navbar-detached bg-navbar-theme">
            <div class="container-xxl">
              <div class="navbar-nav-right d-flex align-items-center">
                <ul class="navbar-nav flex-row align-items-center ms-auto">
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                      <i class="bx bx-bell bx-sm"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li>
                        <a class="dropdown-item" href="javascript:void(0);">
                          <div class="d-flex align-items-center">
                            <i class="bx bx-error-alt bx-sm me-2"></i>
                            <div>
                              <span>Nouvelle alerte de chute</span>
                              <small class="text-muted">Chambre {{ room.room_number }} - Il y a 5 minutes</small>
                            </div>
                          </div>
                        </a>
                      </li>
                    </ul>
                  </li>
                  <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                      <i class="bx bx-user-circle bx-sm"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                      <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">Déconnexion</a></li>

                    </ul>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
          <!-- Content wrapper -->
          <div class="content-wrapper">
            <!-- Content -->
            <div class="container-xxl flex-grow-1 container-p-y">
              <div class="row">
                <div class="col-lg-12 mb-4">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h5 class="m-0">Chambre {{ room.room_number }} - Détails</h5>
                    </div>
                    <div class="card-body">
                      <h6>Informations Générales</h6>
                      <p><strong>Numéro de Chambre :</strong> {{ room.room_number }}</p>
                      <p><strong>Étage :</strong> {{ room.floor }}</p>
                      <p><strong>Type de Chambre :</strong> {{ room.type }}</p>
                      <p><strong>Statut :</strong> {{ 'Occupée' if room.occupied else 'Disponible' }}</p>
                      <p><strong>ID Raspberry :</strong> {{ room.raspberry_id }}</p>
                      <h6>Nombre de Chutes</h6>
                      <p>{{ incident_count }} chutes détectées ce mois-ci.</p>
                    </div>
                  </div>
                </div>
                <div class="col-lg-12 mb-4">
                  <div class="card">
                    <h5 class="card-header">Historique des Chutes</h5>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Date et Heure</th>
                            <th>État</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for incident in incidents %}
                            <tr>
                              <td>{{ incident.date_time }}</td>
                              <td><span class="badge bg-danger">Chute détectée</span></td>
                              <td><button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#videoModal{{ incident.id }}">Regarder</button></td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Content wrapper -->
        </div>
        <!-- Layout page -->
      </div>
    </div>
    <!-- Video Modal Template -->
    {% for incident in incidents %}
      <div class="modal fade" id="videoModal{{ incident.id }}" tabindex="-1" aria-labelledby="videoModalLabel{{ incident.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="videoModalLabel{{ incident.id }}">Vidéo {{ incident.id }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>Video Player Placeholder for Vidéo {{ incident.id }}</p>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}

    <!-- Core JS -->
    <script src="{{ url_for('static', filename='vendor/libs/jquery/jquery.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/libs/popper/popper.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/bootstrap.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
    <script src="{{ url_for('static', filename='vendor/js/menu.js') }}"></script>

    <script>
          document.addEventListener("DOMContentLoaded", function () {
      const token = localStorage.getItem('token');

      if (!token) {
        window.location.href = "/";
      }

      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('token');
        window.location.href = "/";
      })});
    </script>
  </body>
</html>
