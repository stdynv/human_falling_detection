<!doctype html>
<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default" data-assets-path="{{ url_for('static', filename='') }}" data-template="vertical-menu-template-free" data-style="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <title>Contact - Protect Care | Détection de Chute</title>
  <meta name="description" content="Contact page for Protect Care - Fall Detection System" />

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicon/favicon.ico') }}" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fonts/boxicons.css') }}" />

  <!-- Core CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/core.css') }}" class="template-customizer-core-css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/theme-default.css') }}" class="template-customizer-theme-css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/demo.css') }}" />

  <!-- Vendors CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.css') }}" />

  <!-- Helpers -->
  <script src="{{ url_for('static', filename='vendor/js/helpers.js') }}"></script>
  <script src="{{ url_for('static', filename='js/config.js') }}"></script>

  <style>
    #alertModal .modal-body {
      text-align: center;
    }
    #alertRoom {
      font-size: 2.5rem;
      color: red;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    #alertTimer {
      font-size: 2rem;
      color: black;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    #alertVideoPlayer {
      width: 100%;
      height: auto;
      margin-top: 20px;
    }
  </style>
  
</head>

<body>
  <!-- Layout wrapper -->
  <div class="layout-wrapper layout-content-navbar">
    <div class="layout-container">
      <!-- Menu -->
      <aside id="layout-menu" class="layout-menu menu-vertical menu bg-menu-theme">
        <div class="app-brand demo" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 0; height: auto; box-sizing: border-box;">
          <a href="/" class="app-brand-link" style="display: flex; align-items: center; justify-content: center; width: 100%; max-width: 200px;">
            <img src="{{ url_for('static', filename='/img/logo.png') }}" alt="Protect Care Logo" class="app-brand-logo demo" style="max-width: 90%;" />
          </a>
          <a href="javascript:void(0);" class="layout-menu-toggle menu-link text-large d-block d-xl-none">
            <i class="bx bx-chevron-left bx-sm d-flex align-items-center justify-content-center"></i>
          </a>
        </div>
        <ul class="menu-inner py-1">
          <li class="menu-item">
            <a href="/tables-basic" class="menu-link">
              <i class="menu-icon tf-icons bx bx-bar-chart-alt-2"></i>
              <div class="text-truncate">Tableau de Bord</div>
            </a>
          </li>
          <li class="menu-item">
            <a href="/chambres" class="menu-link">
              <i class="menu-icon tf-icons bx bx-file"></i>
              <div class="text-truncate">Chambres</div>
            </a>
          </li>
          <li class="menu-item active open">
            <a href="/contact" class="menu-link">
              <i class="menu-icon tf-icons bx bx-envelope"></i>
              <div class="text-truncate">Contact</div>
            </a>
          </li>
        </ul>
      </aside>      
      
      <!-- / Menu -->

      <!-- Layout container -->
      <div class="layout-page">
        <!-- Navbar -->
        <nav class="layout-navbar navbar navbar-expand-xl navbar-detached align-items-center bg-navbar-theme" id="layout-navbar" style="background-color: transparent;">
          <div class="container-xxl">
            <div class="navbar-nav-right d-flex align-items-center">
              <!-- Notifications -->
              <ul class="navbar-nav flex-row align-items-center ms-auto">
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <i class="bx bx-bell bx-sm"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a class="dropdown-item" href="javascript:void(0);">
                        <div class="d-flex align-items-center">
                          <i class="bx bx-error-alt bx-sm me-2"></i>
                          <div>
                            <span>Nouvelle alerte de chute</span>
                            <small class="d-block text-muted">Chambre 101 - Il y a 5 minutes</small>
                          </div>
                        </div>
                      </a>
                    </li>
                  </ul>
                </li>
                <!-- User Profile -->
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle hide-arrow" href="javascript:void(0);" data-bs-toggle="dropdown">
                    <i class="bx bx-user-circle bx-sm"></i>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/profile">Profil</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0);" id="logoutBtn">Déconnexion</a></li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </nav>
        <!-- / Navbar -->

        

        <!-- Content wrapper -->
        <div class="content-wrapper">
          <!-- Modal for Alerts -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="alertModalLabel">Nouvelle Alerte de Chute</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="alertRoom"></p>
        <p id="alertTimer">00:00</p>
        <!-- Video Player -->
        <video id="alertVideoPlayer" controls>
          <source id="alertVideoSource" src="" type="video/mp4">
          Your browser does not support the video tag.
        </video>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="markAsSeenButton" onclick="markAsSeen()">Vue</button>
      </div>
    </div>
  </div>
</div>

<!-- Ajouter un élément audio pour le son d'alerte -->
<audio id="alertSound" src="{{ url_for('static', filename='/audio/alerte.mp3') }}" preload="auto"></audio>

          <!-- Content -->
          <div class="container-xxl flex-grow-1 container-p-y">
            <div class="card mb-4">
              <h5 class="card-header">Contactez-nous</h5>
              <div class="card-body">
                <form action="{{ url_for('contact_submit') }}" method="post">
                  <div class="mb-3">
                    <label for="name" class="form-label">Nom</label>
                    <input type="text" class="form-control" id="name" name="name" placeholder="Votre Nom" required>
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="Votre Email" required>
                  </div>
                  <div class="mb-3">
                    <label for="room" class="form-label">Chambre Concernée</label>
                    <select class="form-select" id="room" name="room" required>
                      <option value="none" selected>Aucune</option>
                      <option value="all">Toutes</option>
                      {% for room in rooms %}
                          <option value="{{ room.room_number }}">Chambre {{ room.room_number }}</option>
                      {% endfor %}
                    </select>
                  
                  </div>
                  <div class="mb-3">
                    <label for="subject" class="form-label">Sujet de la Réclamation</label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="Sujet de votre réclamation" required>
                  </div>
                  <div class="mb-3">
                    <label for="message" class="form-label">Message</label>
                    <textarea class="form-control" id="message" name="message" rows="4" placeholder="Votre Message" required></textarea>
                  </div>
                  <div class="mb-3">
                    <label for="priority" class="form-label">Niveau de Priorité</label>
                    <select class="form-select" id="priority" name="priority" required>
                      <option value="low">Basse</option>
                      <option value="medium" selected>Moyenne</option>
                      <option value="high">Haute</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="file" class="form-label">Joindre un Fichier (optionnel)</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".jpg,.png,.pdf,.docx">
                  </div>
                  <button type="submit" class="btn btn-primary">Envoyer</button>
                </form>
              </div>
            </div>
          </div>
          <!-- / Content -->
        </div>
        <!-- Content wrapper -->
      </div>
      <!-- / Layout page -->

    </div>

    <!-- Overlay -->
    <div class="layout-overlay layout-menu-toggle"></div>
  </div>
  <!-- / Layout wrapper -->

  <!-- Core JS -->
  <script src="{{ url_for('static', filename='vendor/libs/jquery/jquery.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/libs/popper/popper.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/js/bootstrap.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/libs/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/js/menu.js') }}"></script>

  <!-- Main JS -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
  var socket = io('{{server_url}}', {
    transports: ['websocket'],  // Forces WebSocket only
    reconnection: true,
    reconnectionAttempts: 5,    // Adjust this to suit your needs
    reconnectionDelay: 2000     // Delay reconnection attempts to avoid flooding
  });

  // Listen for connection
  socket.on('connect', function() {
      console.log('Connected to SocketIO server');
  });

  // Listen for the 'notification' event
  socket.on('notification', function(data) {
      console.log('New incident received:', data);

      const room = data.message.split("Room ")[1] || "Unknown";  // Extract room number
      const videoUrl = data.video_url;  // Extract video URL

      // Play the alert sound when a notification is received
      var alertSound = document.getElementById('alertSound');
      alertSound.play().catch(function() {
        console.log('Lecture audio bloquée jusqu\'à une interaction utilisateur');
      });

      // Display the alert popup with the room number and video player
      showAlertPopup(room, videoUrl);
  });

  // Listen for disconnection
  socket.on('disconnect', function() {
      console.log('Disconnected from SocketIO server');
  });

  var timerInterval;

  // Function to show the alert popup
  function showAlertPopup(room, videoUrl) {
    document.getElementById('alertRoom').textContent = "Chambre " + room;
    document.getElementById('alertVideoSource').src = videoUrl;
    document.getElementById('alertVideoPlayer').load();  // Reload the video player with the new source
    startTimer();

    var alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
    alertModal.show();
  }

  // Function to start the timer
  function startTimer() {
    var timerDisplay = document.getElementById('alertTimer');
    var seconds = 0;
    timerInterval = setInterval(function() {
      seconds++;
      var minutes = Math.floor(seconds / 60);
      var remainingSeconds = seconds % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }, 1000);
  }

  // Function to mark the alert as seen and stop the timer
  function markAsSeen() {
    clearInterval(timerInterval);
    var alertModal = bootstrap.Modal.getInstance(document.getElementById('alertModal'));
    alertModal.hide();

    // Stop the alert sound
    var alertSound = document.getElementById('alertSound');
    alertSound.pause();
    alertSound.currentTime = 0; // Reset the audio for the next alert
  }
</script>

</body>
</html>
